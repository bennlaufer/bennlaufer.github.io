---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CategorySection from '../../components/CategorySection.astro';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');
const githubRepos = await getCollection('githubRepos');

// Build a lookup map from repo name → GitHub data
const repoMap = new Map<string, (typeof githubRepos)[number]>();
for (const repo of githubRepos) {
  repoMap.set(repo.data.name, repo);
}

// Helper to enrich project data with GitHub stats
function enrichProject(project: (typeof allProjects)[number]) {
  const gh = repoMap.get(project.data.repoName);
  return {
    title: project.data.title,
    description: project.data.description,
    category: project.data.category,
    tags: project.data.tags,
    repoUrl: gh?.data.url ?? `https://github.com/bennlaufer/${project.data.repoName}`,
    stars: gh?.data.stars,
    forks: gh?.data.raw?.forks_count,
    language: gh?.data.raw?.language ?? undefined,
  };
}

const categories = [
  {
    key: 'data-science-ml' as const,
    title: 'Data Science & Machine Learning',
  },
  {
    key: 'statistical-research' as const,
    title: 'Statistical Analysis & Research',
  },
  {
    key: 'software-tools' as const,
    title: 'Software & Developer Tools',
  },
];

const categorizedProjects = categories.map((cat) => ({
  title: cat.title,
  projects: allProjects
    .filter((p) => p.data.category === cat.key)
    .sort((a, b) => a.data.displayOrder - b.data.displayOrder)
    .map(enrichProject),
}));
---

<BaseLayout title="Projects — Ben Laufer">
  <section class="max-w-6xl mx-auto px-4 py-16 sm:py-24">
    <h1 class="text-4xl font-bold text-white mb-4">Projects</h1>
    <p class="text-gray-400 mb-12 max-w-2xl">
      A collection of projects spanning machine learning, statistical research, and developer tools.
    </p>

    {categorizedProjects.map((cat) => (
      <CategorySection title={cat.title} projects={cat.projects} />
    ))}
  </section>
</BaseLayout>
